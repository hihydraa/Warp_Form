<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>‡πÅ‡∏à‡∏Å‡∏ß‡∏≤‡∏£‡πå‡∏õ ‡∏Ç‡∏∂‡πâ‡∏ô‡∏à‡∏≠</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Cropper.js (‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏£‡∏≠‡∏õ‡∏£‡∏π‡∏õ) -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css"
  />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #111827;
      color: #f9fafb;
      margin: 0;
      padding: 16px;
      display: flex;
      justify-content: center;
    }
    .container {
      width: 100%;
      max-width: 480px;
      background: #1f2933;
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.4);
    }
    h1 {
      font-size: 1.3rem;
      margin-top: 0;
      margin-bottom: 12px;
      text-align: center;
    }
    label {
      display: block;
      margin-top: 12px;
      margin-bottom: 4px;
      font-weight: 600;
    }
    input[type="text"],
    textarea {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #4b5563;
      background: #111827;
      color: #f9fafb;
      font-size: 0.95rem;
    }
    textarea {
      min-height: 80px;
      resize: vertical;
    }
    input[type="file"] {
      margin-top: 4px;
      color: #f9fafb;
    }
    .hint {
      font-size: 0.8rem;
      color: #9ca3af;
      margin-top: 2px;
    }
    button {
      width: 100%;
      margin-top: 16px;
      padding: 10px 16px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, #ec4899, #f97316);
      color: white;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .status {
      margin-top: 12px;
      font-size: 0.9rem;
      text-align: center;
    }
    .status.error {
      color: #fca5a5;
    }
    .status.success {
      color: #6ee7b7;
    }

    /* ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà preview / crop ‡∏£‡∏π‡∏õ‡∏Ç‡∏∂‡πâ‡∏ô‡∏à‡∏≠ */
    .crop-container {
      margin-top: 8px;
      padding: 8px;
      border-radius: 12px;
      border: 1px dashed #4b5563;
      background: #020617;
    }
    .crop-box {
      width: 100%;
      aspect-ratio: 4 / 5;   /* ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö Warp Screen (1080x1350) */
      border-radius: 12px;
      overflow: hidden;
      background: #000;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #warpPreview {
      max-width: 100%;
      display: none;
    }
    .crop-hint {
      margin-top: 6px;
      font-size: 0.8rem;
      color: #9ca3af;
    }

    /* ‡∏ö‡∏•‡πá‡∏≠‡∏Å QR ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô */
    .qr-pay {
      margin-top: 14px;
      padding: 12px;
      border-radius: 12px;
      background: #020617;
      border: 1px solid #374151;
      text-align: center;
    }
    .qr-pay-title {
      font-weight: 600;
      margin-bottom: 8px;
      font-size: 0.95rem;
    }
    .qr-pay-img {
      width: 170px;
      max-width: 70%;
      border-radius: 12px;
      background: #ffffff;
      padding: 8px;
      box-shadow: 0 0 18px rgba(0,0,0,0.6);
    }
    .qr-pay-caption {
      margin-top: 8px;
      font-size: 0.9rem;
      color: #fbbf24;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>‡πÅ‡∏à‡∏Å‡∏ß‡∏≤‡∏£‡πå‡∏õ ‡∏Ç‡∏∂‡πâ‡∏ô‡∏à‡∏≠</h1>

    <form id="warp-form">
      <label for="ig">IG / ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô</label>
      <input type="text" id="ig" placeholder="@your_ig ‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô" required />

      <label for="message">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÇ‡∏ä‡∏ß‡πå‡∏ö‡∏ô‡∏à‡∏≠</label>
      <textarea id="message" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏ß‡∏¢‡∏û‡∏£" required></textarea>

      <!-- ‡∏ö‡∏•‡πá‡∏≠‡∏Å QR ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô -->
      <div class="qr-pay">
        <div class="qr-pay-title">‡∏™‡πÅ‡∏Å‡∏ô QR ‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</div>
        <img
          class="qr-pay-img"
          src="https://hihydraa.github.io/Warp_Form/qrcode_recieve.png"
          alt="QR ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô"
        />
        <div class="qr-pay-caption">20 ‡∏ö‡∏≤‡∏ó 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏µ‡∏£‡∏±‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏Ñ‡∏∑‡∏ô</div>
      </div>

      <label for="warpImage">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÇ‡∏ä‡∏ß‡πå‡∏ö‡∏ô‡∏à‡∏≠</label>
      <input type="file" id="warpImage" accept="image/*" required />
      <div class="hint">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å 1 ‡∏£‡∏π‡∏õ (‡πÑ‡∏ü‡∏•‡πå‡∏†‡∏≤‡∏û)</div>

      <!-- ‡∏Å‡∏•‡πà‡∏≠‡∏á Preview / Crop -->
      <div class="crop-container">
        <div class="crop-box">
          <img id="warpPreview" alt="‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏£‡∏π‡∏õ‡∏ö‡∏ô‡∏à‡∏≠" />
        </div>
        <div class="crop-hint">
          ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô/‡∏ã‡∏π‡∏°‡∏£‡∏π‡∏õ‡πÉ‡∏´‡πâ‡∏û‡∏≠‡∏î‡∏µ‡∏Å‡∏±‡∏ö‡∏Å‡∏£‡∏≠‡∏ö (‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠) ‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏î‡∏™‡πà‡∏á
        </div>
      </div>

      <label for="slipImage">‡∏™‡∏•‡∏¥‡∏õ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</label>
      <input type="file" id="slipImage" accept="image/*" required />
      <div class="hint">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏™‡∏•‡∏¥‡∏õ‡∏´‡∏•‡∏±‡∏á‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢</div>

      <button type="submit">‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
    </form>

    <div id="status" class="status"></div>
  </div>

  <script>
    // ======= 1) CONFIG =======
    const IMGBB_API_KEY   = 'db23dbb367bb9291c84cb6d3d0208075'; // ImgBB API key
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyPe0m5QIrapr1sThYjwTHRASCXhrOf9qTMcRwKrNyPfCCdYvOjT7xS5drG7840O6-ztg/exec';

    const formEl        = document.getElementById('warp-form');
    const statusEl      = document.getElementById('status');
    const warpInputEl   = document.getElementById('warpImage');
    const warpPreviewEl = document.getElementById('warpPreview');

    let warpCropper = null; // ‡∏ï‡∏±‡∏ß cropper ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏π‡∏õ‡∏Ç‡∏∂‡πâ‡∏ô‡∏à‡∏≠

    function canvasToBlob(canvas, type = 'image/jpeg', quality = 0.9) {
      return new Promise((resolve) => {
        canvas.toBlob((blob) => resolve(blob), type, quality);
      });
    }

    // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏Ç‡∏∂‡πâ‡∏ô‡∏à‡∏≠ ‚Üí ‡πÅ‡∏™‡∏î‡∏á preview + ‡∏™‡∏£‡πâ‡∏≤‡∏á Cropper
    warpInputEl.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (ev) => {
        warpPreviewEl.src = ev.target.result;
        warpPreviewEl.style.display = 'block';

        if (warpCropper) {
          warpCropper.destroy();
          warpCropper = null;
        }

        warpCropper = new Cropper(warpPreviewEl, {
          aspectRatio: 4 / 5,
          viewMode: 1,
          dragMode: 'move',
          autoCropArea: 1,
          background: false,
          responsive: true,
        });
      };
      reader.readAsDataURL(file);
    });

    // ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå/Blob ‡πÑ‡∏õ ImgBB
    async function uploadToImgbb(fileOrBlob, label) {
      if (!fileOrBlob) {
        throw new Error(`‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ${label}`);
      }

      const fd = new FormData();
      fd.append('image', fileOrBlob);

      const url = `https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`;

      let res;
      try {
        res = await fetch(url, {
          method: 'POST',
          body: fd
        });
      } catch (e) {
        console.error('fetch to ImgBB failed:', e);
        throw new Error(`‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ ImgBB ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ (${label})`);
      }

      let json;
      try {
        json = await res.json();
      } catch (e) {
        console.error('cannot parse ImgBB response:', e);
        throw new Error(`‡∏≠‡πà‡∏≤‡∏ô‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏à‡∏≤‡∏Å ImgBB ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ (${label})`);
      }

      console.log('ImgBB response', label, json);

      if (!json.success) {
        const msg = (json.error && json.error.message)
          ? json.error.message
          : '‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÑ‡∏õ ImgBB ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
        throw new Error(`${msg} (${label})`);
      }

      return json.data.url;
    }

    // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡πâ‡∏≤ Apps Script ‚Üí Google Sheet
    async function sendToAppsScript(payload) {
      const fd = new FormData();
      fd.append('ig', payload.ig);
      fd.append('message', payload.message);
      fd.append('warpImageUrl', payload.warpImageUrl);
      fd.append('slipImageUrl', payload.slipImageUrl);

      try {
        const res = await fetch(APPS_SCRIPT_URL, {
          method: 'POST',
          body: fd
        });
        console.log('Apps Script response:', res);
        return true;
      } catch (e) {
        console.error('fetch error:', e);
        throw new Error('‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ Google Apps Script ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ');
      }
    }

    // handle submit
    formEl.addEventListener('submit', async (e) => {
      e.preventDefault();

      const btn = formEl.querySelector('button[type="submit"]');
      btn.disabled = true;
      statusEl.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ...';
      statusEl.className = 'status';

      try {
        const ig       = document.getElementById('ig').value.trim();
        const message  = document.getElementById('message').value.trim();
        const slipFile = document.getElementById('slipImage').files[0];

        if (!warpCropper) {
          throw new Error('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡∏∂‡πâ‡∏ô‡∏à‡∏≠ ‡πÅ‡∏•‡∏∞‡∏£‡∏≠‡πÉ‡∏´‡πâ preview ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡πà‡∏≠‡∏ô');
        }

        // 1) ‡∏Ñ‡∏£‡∏≠‡∏õ‡∏£‡∏π‡∏õ‡∏Ç‡∏∂‡πâ‡∏ô‡∏à‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô 1080x1350 ‡πÅ‡∏•‡πâ‡∏ß‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î
        const canvas = warpCropper.getCroppedCanvas({
          width: 1080,
          height: 1350
        });
        const warpBlob = await canvasToBlob(canvas, 'image/jpeg', 0.9);
        const warpImageUrl = await uploadToImgbb(warpBlob, '‡∏£‡∏π‡∏õ‡∏ö‡∏ô‡∏à‡∏≠');

        // 2) ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥
        const slipImageUrl = await uploadToImgbb(slipFile, '‡∏™‡∏•‡∏¥‡∏õ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô');

        statusEl.textContent = '‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...';

        // 3) ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡πâ‡∏≤ Apps Script
        const payload = { ig, message, warpImageUrl, slipImageUrl };
        await sendToAppsScript(payload);

        statusEl.textContent = '‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏£‡πà‡∏ß‡∏°‡∏™‡∏ô‡∏∏‡∏Å üéâ';
        statusEl.className = 'status success';
        formEl.reset();

        if (warpCropper) {
          warpCropper.destroy();
          warpCropper = null;
        }
        warpPreviewEl.src = '';
        warpPreviewEl.style.display = 'none';

      } catch (err) {
        console.error(err);
        statusEl.textContent = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message;
        statusEl.className = 'status error';
      } finally {
        btn.disabled = false;
      }
    });
  </script>
</body>
</html>
